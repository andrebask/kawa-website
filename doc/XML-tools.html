<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Kawa: Working with XML and HTML</title>
<link rel="stylesheet" title="Kawa (navbar: fixed, left)" href="style/kawa-l.css" media="screen, print, projection, tv">
<link rel="alternate stylesheet" title="Kawa (navbar: fixed, right)" href="style/kawa-r.css" media="screen, print, projection, tv">
<link rel="alternate stylesheet" title="Single column, top navigation" href="style/kawa-1col.css" type="text/css" media="handheld, screen, print, projection, tv">

<link rel="home" href="toc.html" title="Kawa: The Kawa Scheme language">
<link rel="up" href="Documentation.html" title="Kawa: Documentation">
<link rel="prev" href="Objects-Classes-and-Modules.html" title="Kawa: Object, Classes and Modules">
<link rel="next" href="Miscellaneous.html" title="Kawa: Miscellaneous topics">

<link rel="stylesheet" href="../kawa-layout.css" type="text/css" media="all">
</head>


<div class="header">
    <a href="../index.html"><img class="logo" src="kawa-logo.png"/></a>
    <h1><a href="../index.html">The Kawa Scheme Language</a></h1>
</div>

<body>
<div class="header">
    <a href="../index.html"><img class="logo" src="kawa-logo.png"/></a>
    <h1><a href="../index.html">The Kawa Scheme Language</a></h1>
</div>
<div class="content">
<div class="navcol">

<div class="navbar">
<ul>
<li><a href="toc.html">Table of Contents</a></li>
<li><a href="tutorial/index.html">Tutorial</a></li>
<li><a href="news.html">News: Recent changes</a></li>
</ul>
<div class="toc"><ul>
<li><a href="../index.html">The Kawa Scheme language</a></li>
<li><a href="Installation.html">Getting and installing Kawa</a></li>
<li><a href="Features.html">Features</a></li>
<li>
<a href="Documentation.html">Documentation</a><ul>
<li><a href="Running.html">Usage Reference</a></li>
<li><a href="Syntax.html">Syntax</a></li>
<li><a href="Program-structure.html">Program structure</a></li>
<li><a href="Multiple-values.html">Multiple values</a></li>
<li><a href="Symbols-and-namespaces.html">Symbols and namespaces</a></li>
<li><a href="Procedures.html">Procedures</a></li>
<li><a href="Numbers.html">Numbers</a></li>
<li><a href="Characters-and-text.html">Characters and text</a></li>
<li><a href="Data-structures.html">Data structures</a></li>
<li><a href="Eval-and-Environments.html">Eval and Environments</a></li>
<li><a href="Debugging.html">Debugging</a></li>
<li><a href="Input-Output.html">Input, output, files</a></li>
<li><a href="Types.html">Types</a></li>
<li><a href="Objects-Classes-and-Modules.html">Object, Classes and Modules</a></li>
<li>
<b class="toc"><a href="XML-tools.html">Working with XML and HTML</a></b><ul>
<li><b class="toc"><a href="XML-tools.html#Formatting-XML">Formatting XML</a></b></li>
<li><b class="toc"><a href="XML-tools.html#Creating-HTML-nodes">Creating HTML nodes</a></b></li>
<li><b class="toc"><a href="XML-tools.html#Creating-XML-nodes">Creating XML nodes</a></b></li>
<li><b class="toc"><a href="XML-tools.html#XML-literals">XML literals</a></b></li>
<li><b class="toc"><a href="XML-tools.html#Server-side-scripts">Web page scripts</a></b></li>
<li><b class="toc"><a href="XML-tools.html#Self-configuring-page-scripts">Self-configuring web page scripts</a></b></li>
<li><b class="toc"><a href="XML-tools.html#Servlets">Installing web page scripts as Servlets</a></b></li>
<li><b class="toc"><a href="XML-tools.html#CGI-scripts">Installing Kawa programs as CGI scripts</a></b></li>
<li><b class="toc"><a href="XML-tools.html#HTTP-requests">Functions for accessing HTTP requests</a></b></li>
<li><b class="toc"><a href="XML-tools.html#HTTP-response">Generating HTTP responses</a></b></li>
<li><b class="toc"><a href="XML-tools.html#XML-beyond-Scheme">Using non-Scheme languages for XML/HTML</a></b></li>
</ul>
</li>
<li><a href="Miscellaneous.html">Miscellaneous topics</a></li>
</ul>
</li>
<li><a href="Development.html">Development</a></li>
<li><a href="Community.html">The Kawa Community</a></li>
<li><a href="About.html">About</a></li>
<li><a href="Overall-Index.html">Index</a></li>
</ul></div>
</div>
</div>
<div class="sect1">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="XML-tools"></a>Working with XML and HTML</h2></div></div></div>
<p>Kawa has a number of features for working with XML, HTML,
and generated web pages.
</p>
<p>In Kawa you don't write XML or HTML directly.
Instead you write expressions that evaluate to “node objects”
corresponding to elements, attributes, and text.
You then write these node objects using either an XML or HTML format.
</p>
<p>Many web-page-generating tools require you to work directly
with raw HTML, as for example:
</p>
<pre class="screen">(display "&lt;p&gt;Don't use the &lt;code&gt;&amp;lt;blink&amp;gt;&lt;/code&gt; tag.&lt;/p&gt;")
</pre>
<p>In Kawa you would instead do:
</p>
<pre class="screen">(display (html:p "Don't use the " (html:code "&lt;blink&gt;") " tag."))
</pre>
<p>The conversion from node objects to XML or HTML is handled by
the formatter (or serializer).
Some advantages of doing it this way are:
</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem"><p>You don't have to worry about quoting special characters.
Missing or incorrect quoting is a common source of bugs
and security problems on systems that work directly with text, such as PHP.
</p></li>
<li class="listitem"><p>Some errors such as mismatched element tags are automatically avoided.
</p></li>
<li class="listitem"><p>The generated generated XML can be validated as it is generated,
or even using compile-time type-checking.  (Kawa doesn't yet do either.)
</p></li>
<li class="listitem"><p>In application that also reads XML,
you can treat XML that is read in and XML that is generated using
the same functions.
</p></li>
</ul></div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="Formatting-XML"></a>Formatting XML</h3></div></div></div>
<p>The easiest way to generate HTML or XML output is to run Kawa
with the appropriate <a class="link" href="Input-Output.html#Named-output-formats" title="Kawa: Named output formats"><code class="literal">--output-format</code> option</a>.
</p>
<p>The intentation is that these output modes should be compatible with
<a class="ulink" href="http://www.w3.org/TR/2006/PR-xslt-xquery-serialization-20061121/" target="_top">XSLT 2.0 and XQuery 1.0 Serialization</a>.
(However, that specifies many options, most
of which have not yet been implemented.
</p>
<div class="variablelist"><dl class="variablelist">
<dt class="term"><code class="literal">xml</code></dt>
<dd><p>Values are printed in XML format.
"Groups" or "elements" are written as using xml element syntax.
Plain characters (such as ‘<code class="literal">&lt;</code>’) are escaped (such as ‘<code class="literal">&amp;lt;</code>’).
</p></dd>
<dt class="term"><code class="literal">xhtml</code></dt>
<dd><p>Same as <code class="literal">xml</code>, but follows the xhtml compatibility guidelines.
</p></dd>
<dt class="term"><code class="literal">html</code></dt>
<dd><p>Values are printed in HTML format.
Mostly same as <code class="literal">xml</code> format, but certain elements without body,
are written without a closing tag.   For example <code class="literal">&lt;img&gt;</code> is written
without <code class="literal">&lt;/img&gt;</code>, which would be illegal for html, but required for xml.
Plain characters (such as ‘<code class="literal">&lt;</code>’) are not escaped inside <code class="literal">&lt;script&gt;</code>
or <code class="literal">&lt;style&gt;</code> elements.
</p></dd>
</dl></div>
<p>To illustrate:
</p>
<pre class="screen">$ kawa --output-format html
#|kawa:1|# (html:img src:"img.jpg")
&lt;img src="img.jpg"&gt;
</pre>
<pre class="screen">$ kawa --output-format xhtml
#|kawa:1|# (html:img src:"img.jpg")
&lt;img xmlns="http://www.w3.org/1999/xhtml" src="img.jpg" /&gt;
</pre>
<pre class="screen">$ kawa --output-format xml
#|kawa:1|# (html:img src:"img.jpg")
&lt;img xmlns="http://www.w3.org/1999/xhtml" src="img.jpg"&gt;&lt;/img&gt;
</pre>
<p>And here is the default <code class="literal">scheme</code> formatting:
</p>
<pre class="screen">$ kawa
#|kawa:1|# (html:img src:"img.jpg")
({http://www.w3.org/1999/xhtml}img src: img.jpg )
</pre>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49478128"></a><code class="function">as-xml</code><em class="replaceable"><code> value</code></em></p>
<div class="blockquote"><blockquote class="blockquote">
<p>Return a value (or multiple values) that when printed will
print <em class="replaceable"><code>value</code></em> in XML syntax.
</p>
<pre class="screen">(require 'xml)
(as-xml (make-element 'p "Some " (make-element 'em "text") "."))
</pre>
<p>prints <code class="literal">&lt;p&gt;Some &lt;em&gt;text&lt;/em&gt;.&lt;/p&gt;</code>.
</p>
</blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49483776"></a><code class="function">unescaped-data</code><em class="replaceable"><code> data</code></em></p>
<div class="blockquote"><blockquote class="blockquote"><p>Creates a special value which causes <code class="literal">data</code> to be printed,
as is, without normal escaping.  For example, when the output format
is XML, then printing <code class="literal">"&lt;?xml?&gt;"</code> prints as ‘<code class="literal">&amp;lt;?xml?&amp;gt;</code>’,
but <code class="literal">(unescaped-data "&lt;?xml?&gt;")</code> prints as  ‘<code class="literal">&lt;?xml?&gt;</code>’.
</p></blockquote></div>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="Creating-HTML-nodes"></a>Creating HTML nodes</h3></div></div></div>
<p>The <code class="literal">html</code> prefix names a special namespace
(see <a class="xref" href="Symbols-and-namespaces.html#Namespaces" title="Kawa: Namespaces and compound symbols">the section called “Namespaces and compound symbols”</a>) of functions to create HTML element nodes.
For example, <code class="literal">html:em</code> is a constructor that
when called creates a element node whose tag is <code class="literal">em</code>.
If this element node is formatted as HTML, the
result has an <code class="literal">&lt;em&gt;</code> tag.
</p>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49496656"></a><code class="function">html:</code><em class="replaceable"><code>tag</code></em><em class="replaceable"><code> attributes</code></em><em class="replaceable"><code> ...</code></em><em class="replaceable"><code> content</code></em><em class="replaceable"><code> ...</code></em></p>
<div class="blockquote"><blockquote class="blockquote">
<p>Creates an element node whose tag is <em class="replaceable"><code>tag</code></em>.
The parameters are first zero or more attributes, followed
by zero of more child values.
An attribute is either an attribute value (possibly
created using <code class="literal">make-attribute</code>), or a pair of arguments:
A keyword followed by the attribute value.
Child values are usually either strings (text content),
or nested element nodes, but can also be comment or processing-instruction
nodes.
</p>
<pre class="screen">(html:a href: "http://gnu.org/" "the "(html:i "GNU")" homepage")
</pre>
</blockquote></div>
</div>
<p>The compound identifier <code class="literal">html:<em class="replaceable"><code>tag</code></em></code> is actually
a type: When you call it as a function you're using Kawa's
standard coercion of a type to its constructor function.
This means you can do type tests:
</p>
<pre class="screen">(define some-node ...)
(if (instance? some-node html:blink)
  (error "blinking not allowed!"))
</pre>
<p>Object identity is currently not fully specified.  Specifically,
it is undefined if a nested (child) element node is copied
“by value” or “by reference”.  This is related to whether
nodes have a parent reference.  In the XPath/XQuery data model
nodes do have a parent reference, and child nodes are conceptually
copied.  (In the actual implemention copying is commonly avoided.)
Kawa/Scheme currently followed the XQuery copying semantics,
which may not be the most appropriate for Scheme.
</p>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="Creating-XML-nodes"></a>Creating XML nodes</h3></div></div></div>
<p>The XML data model is similar to HTML, with one important addition:
XML tags may be <em class="firstterm">qualified names</em>, which are similar
to <a class="link" href="Symbols-and-namespaces.html#Namespaces" title="Kawa: Namespaces and compound symbols">compound symbols</a>.
</p>
<p>You must do this to use the following types and functions:
</p>
<pre class="screen">(require 'xml)
</pre>
<p>The following types and functions assume:
</p>
<pre class="screen">(require 'xml)
</pre>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49511744"></a><code class="function">make-element</code><em class="replaceable"><code> tag</code></em> [<em class="replaceable"><code>attribute</code></em><em class="replaceable"><code> ...</code></em>]<em class="replaceable"><code> child</code></em><em class="replaceable"><code> ...</code></em></p>
<div class="blockquote"><blockquote class="blockquote">
<p>Create a representation of a XML element, corresponding to
</p>
<pre class="screen">&lt;<em class="replaceable"><code>tag</code></em> <em class="replaceable"><code>attribute</code></em>...&gt;<em class="replaceable"><code>child</code></em>...&lt;/<em class="replaceable"><code>tag</code></em>&gt;
</pre>
<p>The result is a <code class="literal">TreeList</code>, though if the result context is a consumer
the result is instead "written" to the consumer.
Thus nested calls to <code class="literal">make-element</code> only result in a
single <code class="literal">TreeList</code>.
More generally, whether an <em class="replaceable"><code>attribute</code></em> or <em class="replaceable"><code>child</code></em> is includded
by copying or by reference is (for now) undefined.
The <em class="replaceable"><code>tag</code></em> should currently be a symbol, though in the future it should
be a qualified name.
An <em class="replaceable"><code>attribute</code></em> is typically a call to <code class="literal">make-attribute</code>,
but it can be any attribute-valued expression.
</p>
<pre class="screen">(make-element 'p
	      "The time is now: "
	      (make-element 'code (make &lt;java.util.Date&gt;)))
</pre>
</blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49524944"></a><code class="function">element-name</code><em class="replaceable"><code> element</code></em></p>
<div class="blockquote"><blockquote class="blockquote"><p>Returns the name (tag) of the element node, as a symbol (QName).
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49528512"></a><code class="function">make-attribute</code><em class="replaceable"><code> name</code></em><em class="replaceable"><code> value...</code></em></p>
<div class="blockquote"><blockquote class="blockquote"><p>Create an "attribute", which is a name-value pair.
For now, <em class="replaceable"><code>name</code></em> should be a symbol.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49532880"></a><code class="function">attribute-name</code><em class="replaceable"><code> element</code></em></p>
<div class="blockquote"><blockquote class="blockquote"><p>Returns the name of the attribute node, as a symbol (QName).
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49536448"></a><code class="function">comment</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Instances of this type represent comment values,
specifically including comments in XML files.
Comment nodes are currently ignored when printing using Scheme formatting,
though that may change.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49539728"></a><code class="function">comment</code><em class="replaceable"><code> comment-text</code></em></p>
<div class="blockquote"><blockquote class="blockquote"><p>Create a comment object with the specified <em class="replaceable"><code>comment-text</code></em>.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49543696"></a><code class="function">processing-instruction</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Instances of this type represent “processing instructions”,
such as may appear in XML files.
Processing-instruction nodes are currently ignored when printing using
Scheme formatting, though that may change.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49547040"></a><code class="function">processing-instruction</code><em class="replaceable"><code> target</code></em><em class="replaceable"><code> contents</code></em></p>
<div class="blockquote"><blockquote class="blockquote"><p>Crreate a processing-instruction object with the specified <em class="replaceable"><code>target</code></em>
(a simple symbol) and <em class="replaceable"><code>contents</code></em> (a string).
</p></blockquote></div>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="XML-literals"></a>XML literals</h3></div></div></div>
<p>You can write XML literals directly in Scheme code,
following a <code class="literal">#</code>.
Notice that the outermost element needs to be prefixed
by <code class="literal">#</code>, but nested elements do not (and must not).
</p>
<pre class="screen">#&lt;p&gt;The result is &lt;b&gt;final&lt;/b&gt;!&lt;/p&gt;
</pre>
<p>Actually, these are not really literals since they can contain
enclosed expressions:
</p>
<pre class="screen">#&lt;em&gt;The result is &amp;{result}.&lt;/em&gt;
</pre>
<p>The value of <em class="replaceable"><code>result</code></em> is substituted into the output,
in a similar way to quasi-quotation.
(If you try to quote one of these “XML literals”,
what you get is unspecified and is subject to change.)
</p>
<p>An <em class="replaceable"><code>xml-literal</code></em> is usually an element constructor,
but there some rarely used forms (processing-instructions,
comments, and CDATA section) we'll cover later.
</p>
<div class="literallayout"><p><a class="indexterm" name="idp49558272"></a><a name="meta-xml-literal"></a><em class="replaceable"><code>xml-literal</code></em> <code class="literal">::=</code> <code class="literal"><span class="bold"><strong>#</strong></span></code><a class="link" href="XML-tools.html#meta-xml-constructor"><em class="replaceable"><code>xml-constructor</code></em></a><br>
<a class="indexterm" name="idp49562992"></a><a name="meta-xml-constructor"></a><em class="replaceable"><code>xml-constructor</code></em> <code class="literal">::=</code> <a class="link" href="XML-tools.html#meta-xml-element-constructor"><em class="replaceable"><code>xml-element-constructor</code></em></a><br>
  | <a class="link" href="XML-tools.html#meta-xml-PI-constructor"><em class="replaceable"><code>xml-PI-constructor</code></em></a><br>
  | <a class="link" href="XML-tools.html#meta-xml-comment-constructor"><em class="replaceable"><code>xml-comment-constructor</code></em></a><br>
  | <a class="link" href="XML-tools.html#meta-xml-CDATA-constructor"><em class="replaceable"><code>xml-CDATA-constructor</code></em></a><br>
</p></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Element-constructors"></a>Element constructors</h4></div></div></div>
<div class="literallayout"><p><a class="indexterm" name="idp49571792"></a><a name="meta-xml-element-constructor"></a><em class="replaceable"><code>xml-element-constructor</code></em> <code class="literal">::=</code><br>
    <code class="literal"><span class="bold"><strong>&lt;</strong></span></code><a class="link" href="XML-tools.html#meta-QName"><em class="replaceable"><code>QName</code></em></a> <a class="link" href="XML-tools.html#meta-xml-attribute"><em class="replaceable"><code>xml-attribute</code></em></a>*<code class="literal"><span class="bold"><strong>&gt;</strong></span></code><a class="link" href="XML-tools.html#meta-xml-element-datum"><em class="replaceable"><code>xml-element-datum</code></em></a>...<code class="literal"><span class="bold"><strong>&lt;/</strong></span></code><a class="link" href="XML-tools.html#meta-QName"><em class="replaceable"><code>QName</code></em></a> <code class="literal"><span class="bold"><strong>&gt;</strong></span></code><br>
  | <code class="literal"><span class="bold"><strong>&lt;</strong></span></code><a class="link" href="XML-tools.html#meta-xml-name-form"><em class="replaceable"><code>xml-name-form</code></em></a> <a class="link" href="XML-tools.html#meta-xml-attribute"><em class="replaceable"><code>xml-attribute</code></em></a>*<code class="literal"><span class="bold"><strong>&gt;</strong></span></code><a class="link" href="XML-tools.html#meta-xml-element-datum"><em class="replaceable"><code>xml-element-datum</code></em></a>...<code class="literal"><span class="bold"><strong>&lt;/&gt;</strong></span></code><br>
  | <code class="literal"><span class="bold"><strong>&lt;</strong></span></code><em class="replaceable"><code>xml-name-form</code></em> <a class="link" href="XML-tools.html#meta-xml-attribute"><em class="replaceable"><code>xml-attribute</code></em></a>*<code class="literal"><span class="bold"><strong>/&gt;</strong></span></code><br>
<a class="indexterm" name="idp49591856"></a><a name="meta-xml-name-form"></a><em class="replaceable"><code>xml-name-form</code></em> <code class="literal">::=</code> <a class="link" href="XML-tools.html#meta-QName"><em class="replaceable"><code>QName</code></em></a><br>
  | <a class="link" href="XML-tools.html#meta-xml-enclosed-expression"><em class="replaceable"><code>xml-enclosed-expression</code></em></a><br>
<a class="indexterm" name="idp49596640"></a><a name="meta-xml-enclosed-expression"></a><em class="replaceable"><code>xml-enclosed-expression</code></em> <code class="literal">::=</code><br>
    <code class="literal"><span class="bold"><strong>@lbracechar{}</strong></span></code><a class="link" href="Syntax.html#meta-expression"><em class="replaceable"><code>expression</code></em></a><code class="literal"><span class="bold"><strong>@rbracechar{}</strong></span></code><br>
  | <code class="literal"><span class="bold"><strong>(</strong></span></code><a class="link" href="Syntax.html#meta-expression"><em class="replaceable"><code>expression</code></em></a>...<code class="literal"><span class="bold"><strong>)</strong></span></code><br>
</p></div>
<p>The first <em class="replaceable"><code>xml-element-constructor</code></em> variant uses a literal <em class="replaceable"><code>QName</code></em>,
and looks like standard non-empty XML element, where the starting <em class="replaceable"><code>QName</code></em>
and the ending <em class="replaceable"><code>QName</code></em> must match exactly:
</p>
<pre class="screen">#&lt;a href="next.html"&gt;Next&lt;/a&gt;
</pre>
<p>As a convenience, you can leave out the ending tag(s):
</p>
<pre class="screen">&lt;para&gt;This is a paragraph in &lt;emphasis&gt;DocBook&lt;/&gt; syntax.&lt;/&gt;
</pre>
<p>You can use an expression to compute the element tag at runtime -
in that case you <span class="emphasis"><em>must</em></span> leave out the ending tag:
</p>
<pre class="screen">#&lt;p&gt;This is &lt;(if be-bold 'strong 'em)&gt;important&lt;/&gt;!&lt;/p&gt;
</pre>
<p>You can use arbitrary <em class="replaceable"><code>expression</code></em> inside curly braces,
as long as it evaluates to a symbol.
You can leave out the curly braces
if the <em class="replaceable"><code>expression</code></em> is a simple parenthesised compound expression.
The previous example is equivalent to:
</p>
<pre class="screen">#&lt;p&gt;This is &lt;{(if be-bold 'strong 'em)}&gt;important&lt;/&gt;!&lt;/p&gt;
</pre>
<p>The third <em class="replaceable"><code>xml-element-constructor</code></em> variant above is an XML
“empty element”; it is equivalent to the second variant
when there are no <em class="replaceable"><code>xml-element-datum</code></em> items.
</p>
<p>(Note that every well-formed XML element, as defined in the XML specifications,
is a valid <em class="replaceable"><code>xml-element-constructor</code></em>, but not vice versa.)
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Elements-contents-(children)"></a>Elements contents (children)</h4></div></div></div>
<p>The “contents” (children) of an element
are a sequence of character (text) data, and nested nodes.
The characters <code class="literal">&amp;</code>, <code class="literal">&lt;</code>, and <code class="literal">&gt;</code> are special,
and need to be escaped.
</p>
<div class="literallayout"><p><a class="indexterm" name="idp49619664"></a><a name="meta-xml-element-datum"></a><em class="replaceable"><code>xml-element-datum</code></em> <code class="literal">::=</code><br>
    any character except <code class="literal">&amp;</code>, or <code class="literal">&lt;</code>.<br>
  | <a class="link" href="XML-tools.html#meta-xml-constructor"><em class="replaceable"><code>xml-constructor</code></em></a><br>
  | <a class="link" href="XML-tools.html#meta-xml-escaped"><em class="replaceable"><code>xml-escaped</code></em></a><br>
<a class="indexterm" name="idp49625840"></a><a name="meta-xml-escaped"></a><em class="replaceable"><code>xml-escaped</code></em> <code class="literal">::=</code><br>
    <code class="literal"><span class="bold"><strong>&amp;</strong></span></code><a class="link" href="XML-tools.html#meta-xml-enclosed-expression"><em class="replaceable"><code>xml-enclosed-expression</code></em></a><br>
  | <code class="literal"><span class="bold"><strong>&amp;</strong></span></code><a class="link" href="XML-tools.html#meta-xml-entity-name"><em class="replaceable"><code>xml-entity-name</code></em></a><code class="literal"><span class="bold"><strong>;</strong></span></code><br>
  | <a class="link" href="XML-tools.html#meta-xml-character-reference"><em class="replaceable"><code>xml-character-reference</code></em></a><br>
<a class="indexterm" name="idp49634576"></a><a name="meta-xml-character-reference"></a><em class="replaceable"><code>xml-character-reference</code></em> <code class="literal">::=</code><br>
    <code class="literal"><span class="bold"><strong>&amp;#</strong></span></code><a class="link" href="Syntax.html#meta-digit"><em class="replaceable"><code>digit</code></em></a>+<code class="literal"><span class="bold"><strong>;</strong></span></code><br>
  | <code class="literal"><span class="bold"><strong>&amp;#x</strong></span></code><a class="link" href="Syntax.html#meta-hex-digit"><em class="replaceable"><code>hex-digit</code></em></a>+<code class="literal"><span class="bold"><strong>;</strong></span></code><br>
</p></div>
<p>Here is an example shows both hex and decimal character references:
</p>
<pre class="screen">#&lt;p&gt;A&amp;#66;C&amp;#x44;E&lt;/p&gt;  ⇒  &lt;p&gt;ABCDE&lt;/p&gt;
</pre>
<div class="literallayout"><p><a class="indexterm" name="idp49645024"></a><a name="meta-xml-entity-name"></a><em class="replaceable"><code>xml-entity-name</code></em> <code class="literal">::=</code> <a class="link" href="Syntax.html#meta-identifier"><em class="replaceable"><code>identifier</code></em></a><br>
</p></div>
<p>Currently, the only supported values for <em class="replaceable"><code>xml-entity-name</code></em>
are the builtin XML names <code class="literal">lt</code>, <code class="literal">gt</code>, <code class="literal">amp</code>,
<code class="literal">quot</code>, and <code class="literal">apos</code>, which stand for the characters
<code class="literal">&lt;</code>, <code class="literal">&gt;</code>, <code class="literal">&amp;</code>, <code class="literal">"</code>, and <code class="literal">'</code>, respectively.
The following two expressions are equivalent:
</p>
<pre class="screen">#&lt;p&gt;&amp;lt; &amp;gt; &amp;amp; &amp;quot; &amp;apos;&lt;/p&gt;
#&lt;p&gt;&amp;{"&lt; &gt; &amp; \" '"}&lt;/p&gt;
</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Attributes"></a>Attributes</h4></div></div></div>
<div class="literallayout"><p><a class="indexterm" name="idp49658832"></a><a name="meta-xml-attribute"></a><em class="replaceable"><code>xml-attribute</code></em> <code class="literal">::=</code><br>
    <a class="link" href="XML-tools.html#meta-xml-name-form"><em class="replaceable"><code>xml-name-form</code></em></a><code class="literal"><span class="bold"><strong>=</strong></span></code><a class="link" href="XML-tools.html#meta-xml-attribute-value"><em class="replaceable"><code>xml-attribute-value</code></em></a><br>
<a class="indexterm" name="idp49664368"></a><a name="meta-xml-attribute-value"></a><em class="replaceable"><code>xml-attribute-value</code></em> <code class="literal">::=</code><br>
    <code class="literal"><span class="bold"><strong>"</strong></span></code><a class="link" href="XML-tools.html#meta-quot-attribute-datum"><em class="replaceable"><code>quot-attribute-datum</code></em></a>*<code class="literal"><span class="bold"><strong>"</strong></span></code><br>
  | <code class="literal"><span class="bold"><strong>'</strong></span></code><a class="link" href="XML-tools.html#meta-apos-attribute-datum"><em class="replaceable"><code>apos-attribute-datum</code></em></a>*<code class="literal"><span class="bold"><strong>'</strong></span></code><br>
<a class="indexterm" name="idp49673312"></a><a name="meta-quot-attribute-datum"></a><em class="replaceable"><code>quot-attribute-datum</code></em> <code class="literal">::=</code><br>
    any character except <code class="literal">"</code>, <code class="literal">&amp;</code>, or <code class="literal">&lt;</code>.<br>
  | <a class="link" href="XML-tools.html#meta-xml-escaped"><em class="replaceable"><code>xml-escaped</code></em></a><br>
<a class="indexterm" name="idp49679088"></a><a name="meta-apos-attribute-datum"></a><em class="replaceable"><code>apos-attribute-datum</code></em> <code class="literal">::=</code><br>
    any character except <code class="literal">'</code>, <code class="literal">&amp;</code>, or <code class="literal">&lt;</code>.<br>
  | <a class="link" href="XML-tools.html#meta-xml-escaped"><em class="replaceable"><code>xml-escaped</code></em></a><br>
</p></div>
<p>If the <em class="replaceable"><code>xml-name-form</code></em> is either <code class="literal">xmlns</code> or
a compound named with the prefix <code class="literal">xmlns</code>, then
technically we have a namespace declaration, rather than
an attribute.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="QNames-and-namespaces"></a>QNames and namespaces</h4></div></div></div>
<p>The names of elements and attributes are <em class="firstterm">qualified names</em>
(QNames), which are represented using compound symbols (see <a class="xref" href="Symbols-and-namespaces.html#Namespaces" title="Kawa: Namespaces and compound symbols">the section called “Namespaces and compound symbols”</a>).
The lexical syntax for a QName is either a simple identifier,
or a (prefix,local-name) pair:
</p>
<div class="literallayout"><p><a class="indexterm" name="idp49690768"></a><a name="meta-QName"></a><em class="replaceable"><code>QName</code></em> <code class="literal">::=</code> <a class="link" href="XML-tools.html#meta-xml-local-part"><em class="replaceable"><code>xml-local-part</code></em></a><br>
   | <a class="link" href="XML-tools.html#meta-xml-prefix"><em class="replaceable"><code>xml-prefix</code></em></a><code class="literal"><span class="bold"><strong>:</strong></span></code><a class="link" href="XML-tools.html#meta-xml-local-part"><em class="replaceable"><code>xml-local-part</code></em></a><br>
<a class="indexterm" name="idp49697312"></a><a name="meta-xml-local-part"></a><em class="replaceable"><code>xml-local-part</code></em> <code class="literal">::=</code> <a class="link" href="Syntax.html#meta-identifier"><em class="replaceable"><code>identifier</code></em></a><br>
<a class="indexterm" name="idp49700928"></a><a name="meta-xml-prefix"></a><em class="replaceable"><code>xml-prefix</code></em> <code class="literal">::=</code> <a class="link" href="Syntax.html#meta-identifier"><em class="replaceable"><code>identifier</code></em></a><br>
</p></div>
<p>An <em class="replaceable"><code>xml-prefix</code></em> is an alias for a namespace-uri,
and the mapping between them is defined by a namespace-declaration.
You can either use a <code class="literal">define-namespace</code> form, or you
can use a <em class="firstterm">namespace declaration attribute</em>:
</p>
<div class="literallayout"><p><a class="indexterm" name="idp49707392"></a><a name="meta-xml-namespace-declaration-attribute"></a><em class="replaceable"><code>xml-namespace-declaration-attribute</code></em> <code class="literal">::=</code><br>
    <code class="literal"><span class="bold"><strong>xmlns:</strong></span></code><a class="link" href="XML-tools.html#meta-xml-prefix"><em class="replaceable"><code>xml-prefix</code></em></a><code class="literal"><span class="bold"><strong>=</strong></span></code><a class="link" href="XML-tools.html#meta-xml-attribute-value"><em class="replaceable"><code>xml-attribute-value</code></em></a><br>
  | <code class="literal"><span class="bold"><strong>xmlns=</strong></span></code><a class="link" href="XML-tools.html#meta-xml-attribute-value"><em class="replaceable"><code>xml-attribute-value</code></em></a><br>
</p></div>
<p>The former declares <em class="replaceable"><code>xml-prefix</code></em> as a namespace alias for
the namespace-uri specified by <em class="replaceable"><code>xml-attribute-value</code></em>
(which must be a compile-time constant).
The second declares that <em class="replaceable"><code>xml-attribute-value</code></em> is the default
namespace for simple (unprefixed) element tags.
(A default namespace declaration is ignored for attribute names.)
</p>
<pre class="screen">(let ((qn (element-name #&lt;gnu:b xmlns:gnu="http://gnu.org/"/&gt;)))
  (list (symbol-local-name qn)
        (symbol-prefix qn)
        (symbol-namespace-uri qn)))
⇒ ("b" "gnu" "http://gnu.org/")

</pre>
</div>
<div class="sect3"><div class="titlepage"><div><div><h4 class="title">
<a name="Other-XML-types"></a>Other XML types</h4></div></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Processing-instructions"></a>Processing instructions</h4></div></div></div>
<p>An <em class="replaceable"><code>xml-PI-constructor</code></em> can be used to create an XML
<em class="firstterm">processing instruction</em>, which can be used to pass
instructions or annotations to an XML processor (or tool).
(Alternatively, you can use the <code class="literal">processing-instruction</code>
type constructor.)
</p>
<div class="literallayout"><p><a class="indexterm" name="idp49723920"></a><a name="meta-xml-PI-constructor"></a><em class="replaceable"><code>xml-PI-constructor</code></em> <code class="literal">::=</code> <code class="literal"><span class="bold"><strong>&lt;?</strong></span></code><a class="link" href="XML-tools.html#meta-xml-PI-target"><em class="replaceable"><code>xml-PI-target</code></em></a> <a class="link" href="XML-tools.html#meta-xml-PI-content"><em class="replaceable"><code>xml-PI-content</code></em></a><code class="literal"><span class="bold"><strong>?&gt;</strong></span></code><br>
<a class="indexterm" name="idp49730544"></a><a name="meta-xml-PI-target"></a><em class="replaceable"><code>xml-PI-target</code></em> <code class="literal">::=</code> <em class="replaceable"><code>NCname</code></em> (i.e. a simple (non-compound) identifier)<br>
<a class="indexterm" name="idp49733712"></a><a name="meta-xml-PI-content"></a><em class="replaceable"><code>xml-PI-content</code></em> <code class="literal">::=</code> any characters, not containing <code class="literal">?&gt;</code>.<br>
</p></div>
<p>For example, the DocBook XSLT stylesheets can use the <code class="literal">dbhtml</code>
instructions to specify that a specific chapter should be
written to a named HTML file:
</p>
<pre class="screen">#&lt;chapter&gt;&lt;?dbhtml filename="intro.html" ?&gt;
&lt;title&gt;Introduction&lt;/title&gt;
...
&lt;/chapter&gt;
</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="XML-comments"></a>XML comments</h4></div></div></div>
<p>You can cause XML comments to be emitted in the XML output document.
Such comments can be useful for humans reading the XML document,
but are usually ignored by programs.
(Alternatively, you can use the <code class="literal">comment</code> type constructor.)
</p>
<div class="literallayout"><p><a class="indexterm" name="idp49742240"></a><a name="meta-xml-comment-constructor"></a><em class="replaceable"><code>xml-comment-constructor</code></em> <code class="literal">::=</code> <code class="literal"><span class="bold"><strong>&lt;!--</strong></span></code><a class="link" href="XML-tools.html#meta-xml-comment-content"><em class="replaceable"><code>xml-comment-content</code></em></a><code class="literal"><span class="bold"><strong>--&gt;</strong></span></code><br>
<a class="indexterm" name="idp49747888"></a><a name="meta-xml-comment-content"></a><em class="replaceable"><code>xml-comment-content</code></em> <code class="literal">::=</code> any characters, not containing <code class="literal">--</code>.<br>
</p></div>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="CDATA-sections"></a>CDATA sections</h4></div></div></div>
<p>A <code class="literal">CDATA</code> section can be used to avoid excessive use of
<em class="replaceable"><code>xml-entity-ref</code></em> such as <code class="literal">&amp;amp;</code> in element content.
</p>
<div class="literallayout"><p><a class="indexterm" name="idp49755376"></a><a name="meta-xml-CDATA-constructor"></a><em class="replaceable"><code>xml-CDATA-constructor</code></em> <code class="literal">::=</code> <code class="literal"><span class="bold"><strong>&lt;![CDATA[</strong></span></code><a class="link" href="XML-tools.html#meta-xml-CDATA-content"><em class="replaceable"><code>xml-CDATA-content</code></em></a><code class="literal"><span class="bold"><strong>]]&gt;</strong></span></code><br>
<a class="indexterm" name="idp49761072"></a><a name="meta-xml-CDATA-content"></a><em class="replaceable"><code>xml-CDATA-content</code></em> <code class="literal">::=</code> any characters, not containing <code class="literal">]]&gt;</code>.<br>
</p></div>
<p>The following are equivalent:
</p>
<pre class="screen">#&lt;p&gt;Specal characters &lt;![CDATA[&lt; &gt; &amp; ' "]]&gt; here.&lt;/p&gt;
#&lt;p&gt;Specal characters &amp;lt; &amp;gt; &amp;amp; &amp;quot; &amp;apos; here.&lt;/p&gt;
</pre>
<p>Kawa remembers that you used a <code class="literal">CDATA</code> section in
the <em class="replaceable"><code>xml-element-constructor</code></em> and will write it out
using a <code class="literal">CDATA</code> constructor.
</p>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="Server-side-scripts"></a>Web page scripts</h3></div></div></div>
<p>A Kawa <em class="firstterm">web page script</em> is a Kawa program that is invoked
by a web server because the server received an HTTP request.
The result of evaluating the top-level expressions becomes
the HTTP response that the servlet sends back to the client, usually a browser.
</p>
<p>A web page script may be as simple as:
</p>
<pre class="screen">(format "The time is &lt;~s&gt;." (java.util.Date))
</pre>
<p>This returns a response of consisting of a formatted string
giving the current time.
The string would interpreted as <code class="literal">text/plain</code> content:
The angle brackets are regular characters, and not
HTML tag markers.
</p>
<p>The script can alternatively evaluate to XML/HTML node
values, for example those created by <a class="xref" href="XML-tools.html#XML-literals" title="Kawa: XML literals">the section called “XML literals”</a>:
</p>
<pre class="screen">#&lt;p&gt;Hello, &lt;b&gt;&amp;(request-remote-host)&lt;/b&gt;!&lt;/p&gt;
</pre>
<p>In this case the response would be <code class="literal">text/html</code> or similar content:
The angle brackets should be interpreted by the browser as HTML tag markers.
The function <code class="literal">request-remote-host</code> is available (automatically)
to web page scripts; it returns the host that made the HTTP request,
which is then interpolated into the response.
</p>
<p>Following sections will go into more details about how
to write web page scripts.  You can do so in any supported
Kawa language, including Scheme, BRL, KRL, or XQuery.
</p>
<p>A web server will use a URL mapping to map a request URL
to a specific web page script.  This can be done in a
number of different ways:
</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem"><p>The easiest to manage is to use Kawa's mechanism for
<a class="xref" href="XML-tools.html#Self-configuring-page-scripts" title="Kawa: Self-configuring web page scripts">the section called “Self-configuring web page scripts”</a>.  Ths is especially
easy if you the web server built in to JDK 6, since no
configuration files are needed.
You can also use a “servlet engine” like Tomcat or Glassfish.
</p></li>
<li class="listitem"><p>You can explicitly compile the web page script to a servlet,
in the same way Java servlets are compiled.
This can then be installed ("deployed") in a servlet-supporting
web server, such a Tomcat or Glassfish.  See <a class="xref" href="XML-tools.html#Servlets" title="Kawa: Installing web page scripts as Servlets">the section called “Installing web page scripts as Servlets”</a>.
</p></li>
<li class="listitem"><p>You can run the servlet as a <a class="link" href="XML-tools.html#CGI-scripts" title="Kawa: Installing Kawa programs as CGI scripts">CGI script</a>.
</p></li>
</ul></div>
<p>For details on how to extract information from the request
see <a class="xref" href="XML-tools.html#HTTP-requests" title="Kawa: Functions for accessing HTTP requests">the section called “Functions for accessing HTTP requests”</a>.
For details on how the response is created see <a class="link" href="XML-tools.html#HTTP-response" title="Kawa: Generating HTTP responses">Generating HTTP responses</a>.
If the response is HTML or XML, you may want to
read <a class="xref" href="XML-tools.html#Creating-HTML-nodes" title="Kawa: Creating HTML nodes">the section called “Creating HTML nodes”</a>, or <a class="xref" href="XML-tools.html#Creating-XML-nodes" title="Kawa: Creating XML nodes">the section called “Creating XML nodes”</a>,
or <a class="xref" href="XML-tools.html#XML-literals" title="Kawa: XML literals">the section called “XML literals”</a>.
</p>
<p>Here are some examples, starting with a simple <code class="literal">hello.scm</code>:
</p>
<pre class="screen">(response-content-type 'text/html) ; Optional
(html:p
  "The request URL was: " (request-url))
(make-element 'p
  (let ((query (request-query-string)))
    (if query
      (values-append "The query string was: " query)
      "There was no query string.")))
</pre>
<p>This returns two <code class="literal">&lt;p&gt;</code> (paragraph) elements: One using
<code class="literal">make-element</code> and one using the <code class="literal">html:p</code> constructor.
Or you may prefer to use <a class="xref" href="XML-tools.html#XML-literals" title="Kawa: XML literals">the section called “XML literals”</a>.
</p>
<p>The same program using KRL:
</p>
<pre class="screen">&lt;p&gt;The request URL was: [(request-url)]&lt;/p&gt;,
&lt;p&gt;[(let ((query (request-query-string)))
    (if query
      (begin ]The query string was: [query)

      ]There was no query string.[))]&lt;/p&gt;
</pre>
<p>You can also use XQuery:
</p>
<pre class="screen">&lt;p&gt;The request URL was: {request-url()}&lt;/p&gt;
&lt;p&gt;{let $query := request-query-string() return
    if ($query)
    then ("The query string was: ",$query)
    else "There was no query string."}&lt;/p&gt;
</pre>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="Self-configuring-page-scripts"></a>Self-configuring web page scripts</h3></div></div></div>
<p>Kawa makes it easy to set up a web site without configuration
files.  Instead, the mapping from request URL to web page script
matches the layout of files in the application directory.
</p>
<p>Many web servers make it easy to execute a script using a script
processor which is selected depending on the extension of the
requested URL. That is why you see lots of URLs that end in
<code class="literal">.cgi</code>, <code class="literal">.php</code>, or <code class="literal">.jsp</code>. This is bad, because it
exposes the server-side implementation to the user: Not only are such
URLs ugly, but they make it difficult to change the server without
breaking people's bookmarks and search engines. A server will usually
provide a mechanism to use prettier URLs, but doing so requires extra
effort, so many web-masters don't.
</p>
<p>If you want a script to be executed in response to a URL
<code class="literal">http://host/app/foo/bar</code> you give the script the name
<code class="literal">app/foo/bar</code>, in the appropriate server “application”
directory (as explained below). You get to pick the name <code class="literal">bar</code>.
Or you can use the name <code class="literal">bar.html</code>, even though the file named
<code class="literal">bar.html</code> isn't actually
an html file - rather it produces html when evaluated. Or better: just use
a name without an extension at all.
Kawa figures
out what kind of script it is based on the content of the file,
rather than the file name.  Once Kawa has
found a script, it looks at the first line to see if it can recognize
the kind (language) of the script. Normally this would be a comment
that contains the name of a programming language that Kawa
knows about.  For example:
</p>
<pre class="screen">;; Hello world page script written in -*- scheme -*-
#&lt;p&gt;Hello, &lt;b&gt;&amp;(request-remote-host)&lt;/b&gt;!&lt;/p&gt;
</pre>
<p>(Using the funny-looking string <code class="literal">-*- scheme -*-</code> has the
bonus is that it recognized by the Emacs text editor.)
</p>
<p>A script named <code class="literal">+default+</code> is run if there isn't a matching script.
For example assume the following is a file named <code class="literal">+default</code>.
</p>
<pre class="screen">;; This is -*- scheme -*-
(make-element 'p "servlet-path: " (request-servlet-path))
</pre>
<p>This becomes the default script for HTTP requests that aren't handled
by a more specific script.
The <code class="literal">request-servlet-path</code> function
returns the "servlet path", which is the part of the requested URL
that is relative to the current web application. Thus a request for
<code class="literal">http://host:port/app/this/is/a/test</code> will return:
</p>
<pre class="screen">servlet-path: /this/is/a/test
</pre>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Using-the-OpenJDK-built-in-web-server"></a>Using the OpenJDK built-in web server</h4></div></div></div>
<p>The easiest way to run a Kawa web server is to
use the web server built in to JDK 6 or later.
</p>
<pre class="screen">kawa --http-auto-handler <em class="replaceable"><code>context-path</code></em> <em class="replaceable"><code>appdir</code></em> --http-start <em class="replaceable"><code>port</code></em>
</pre>
<p>This starts a web server that listens on the given <em class="replaceable"><code>port</code></em>,
using the files in directory <em class="replaceable"><code>appdir</code></em> to handle
requests that start with the given <em class="replaceable"><code>context-path</code></em>.
The <em class="replaceable"><code>context-path</code></em> must start with a <code class="literal">"/"</code> (one is added if
needed), and it is recommended that it also end with a <code class="literal">"/"</code>
(otherwise you might get some surprising behavior).
</p>
<p>You can specify multiple <code class="literal">--http-auto-handler</code> options.
</p>
<p>For example use the files in the current directory to handle
all requests on the standard port 80 do:
</p>
<pre class="screen">kawa --http-auto-handler / . --http-start 80
</pre>
<p>There are some examples in the <code class="literal">testsuite/webtest</code> directory
the Kawa source distribution.  You can start the server thus:
</p>
<pre class="screen">bin/kawa --http-auto-handler / testsuite/webtest/ --http-start 8888
</pre>
<p>and then for example browse to <code class="literal">http://localhost:8888/adder.scm</code>.
</p>
<p>For lots of information about the HTTP request, browse to
<code class="literal">http://localhost:8888/info/<em class="replaceable"><code>anything</code></em></code>.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Using-a-servlet-container"></a>Using a servlet container</h4></div></div></div>
<p>You can also can use a “servlet container”
such as Tomcat or Glassfish with self-configuring script.
See <a class="xref" href="XML-tools.html#Servlets" title="Kawa: Installing web page scripts as Servlets">the section called “Installing web page scripts as Servlets”</a> for information on how to install
these servers, and the concept of web applications.
Once you have these server installed, you create a
web application with the following in the
<code class="literal"><em class="replaceable"><code>appdir</code></em>/WEB-INF/web.xml</code> configuration file:
</p>
<pre class="screen">&lt;web-app&gt;
  &lt;display-name&gt;Kawa auto-servlet&lt;/display-name&gt;
  &lt;servlet&gt;
    &lt;servlet-name&gt;KawaPageServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;gnu.kawa.servlet.KawaPageServlet&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;KawaPageServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
&lt;/web-app&gt;
</pre>
<p>This creates a web application where all URLs
are handled by the <code class="literal">gnu.kawa.servlet.KawaPageServlet</code> servlet class,
which is included in the Kawa jar file.
The <code class="literal">KawaPageServlet</code> class handles the searching
and compiling described in this page.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Finding-a-matching-script"></a>Finding a matching script</h4></div></div></div>
<p>When Kawa receives a request for:
</p>
<pre class="screen">http://host:port/appname/a/b/anything
</pre>
<p>it will look for a file:
</p>
<pre class="screen"><em class="replaceable"><code>appdir</code></em>/a/b/anything
</pre>
<p>If such a file exists, the script will be executed, as described
below. If not, it will look for a file name <code class="literal">+default+</code> in the same
directory. If that desn't exist either, it will look for <code class="literal">+default+</code>
in the parent
directory, then the grand-parent directory, and so on until it gets to
the appname web application root directory. So the default script is
this: <code class="literal"><em class="replaceable"><code>appdir</code></em>/+default</code>.
</p>
<p>If that doesn't exist then Kawa returns a 404 "page not found" error.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Determining-script-language"></a>Determining script language</h4></div></div></div>
<p>Once Kawa has found a script file corresponding to a request URL,
it needs to determine if this is a data file or a web page script,
and in the latter case, what language it is written in.
</p>
<p>Kawa recognizes the following "magic strings" in the first line of a script:
</p>
<div class="variablelist"><dl class="variablelist">
<dt class="term"><code class="literal">kawa:scheme</code></dt>
<dd><p>The Scheme language.
</p></dd>
<dt class="term"><code class="literal">kawa:xquery</code></dt>
<dd><p>The XQuery language.
</p></dd>
<dt class="term"><code class="literal">kawa:<em class="replaceable"><code>language</code></em></code></dt>
<dd><p>Some other language known to Kawa.
</p></dd>
</dl></div>
<p>Kawa also recognizes Emacs-style "mode specifiers":
</p>
<div class="variablelist"><dl class="variablelist">
<dt class="term"><code class="literal">-*- scheme -*-</code></dt>
<dd><p>The Scheme language.
</p></dd>
<dt class="term"><code class="literal">-*- xquery -*-</code></dt>
<dd><p>The XQuery language (though Emacs doesn't know about XQuery).
</p></dd>
<dt class="term"><code class="literal">-*- emacs-lisp -*-</code></dt>
<dt class="term"><code class="literal">-*- elisp -*-</code></dt>
<dd><p>The Emacs Lisp extension language.
</p></dd>
<dt class="term"><code class="literal">-*- common-lisp -*-</code></dt>
<dt class="term"><code class="literal">-*- lisp -*-</code></dt>
<dd><p>    The Common Lisp language.
</p></dd>
</dl></div>
<p>Also, it also recognizes comments in the first two columns of the line:
</p>
<div class="variablelist"><dl class="variablelist">
<dt class="term"><code class="literal">;;</code></dt>
<dd><p>A Scheme or Lisp comment - assumed to be in the Scheme language.
</p></dd>
<dt class="term"><code class="literal">(:</code></dt>
<dd><p>Start of an XQuery comment, so assumed to be in the XQuery language.
</p></dd>
</dl></div>
<p>If Kawa doesn't recognize the language of a script (and it
isn't named +default+) then it assumes the file is a data file. It
asks the servlet engine to figure out the content type (using the
getMimeType method of ServletContext), and just copies the file into
the response.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Compilation-and-caching"></a>Compilation and caching</h4></div></div></div>
<p>Kawa automatically compiles a script into a class. The
class is internal to the server, and is not written out to
disk. (There is an unsupported option to write the compiled file to a
class file, but there is no support to use previously-compiled
classes.) The server then creates a module instance to handle the
actual request, and runs the body (the <code class="literal">run</code> method)
of the script class. On subsequence
requests for the same script, the same class and instance are reused;
only the <code class="literal">run</code> is re-executed.
</p>
<p>If the script is changed, then it is re-compiled and a new module
instance created. This makes it very easy to develop and modify a
script. (Kawa for performance reasons doesn't check more
than once a second whether a script has been modified.)
</p>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="Servlets"></a>Installing web page scripts as Servlets</h3></div></div></div>
<p>You can compile a Kawa program to a <a class="ulink" href="http://en.wikipedia.org/wiki/Java_Servlet" target="_top">Servlet</a>, and run it
in a servlet engine (a Servlet-aware web server).
One or more servlets are installed together as a web application.
This section includes specific information for
the Tomcat and Glassfish web servers.
</p>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Creating-a-web-application"></a>Creating a web application</h4></div></div></div>
<p>A <em class="firstterm">web application</em> is a group of data, servlets, and
configuration files to handle a related set of URLs.
The <a class="ulink" href="http://jcp.org/aboutJava/communityprocess/final/jsr315/index.html" target="_top">servlet specification</a>
specifies the directory structure of a web application.
</p>
<p>Assume the web application is called <code class="literal">myapp</code>, and lives in a
directory with the same name.  The application normally handles
requests for URLs that start with <code class="literal">http://example.com/myapp</code>.
Most files in the application directory are used to handle
requests with corresponding URL.  For example,
a file <code class="literal">myapp/list/help.html</code> would be the response
to the request <code class="literal">http://example.com/myapp/list/help.html</code>.
</p>
<p>The directory <code class="literal">WEB-INF</code> is special.  It contains configuration
files, library code, and other server data.
</p>
<p>So to create the <code class="literal">myapp</code> application, start with:
</p>
<pre class="screen">mkdir myapp
cd myapp
mkdir WEB-INF WEB-INF/lib WEB-INF/classes
</pre>
<p>Copy the Kawa jar from the <code class="literal">lib</code> direcory.
(You can also use a “hard” link, but symbolic links may not
work, for security systems.)
</p>
<pre class="screen">cp <em class="replaceable"><code>kawa-home</code></em>/kawa-1.14.1.jar WEB-INF/lib/kawa.jar
</pre>
<p>You should also create the file <code class="literal">WEB-INF/web.xml</code>.
For now, this is is just a place-holder:
</p>
<pre class="screen">&lt;web-app&gt;
  &lt;display-name&gt;My Application&lt;/display-name&gt;
&lt;/web-app&gt;
</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Compiling-a-web-page-script-to-a-servlet"></a>Compiling a web page script to a servlet</h4></div></div></div>
<p>Assume for simplicity that the source files
are in the <code class="literal">WEB-INF/classes</code> directory, and make that the
current directory:
</p>
<pre class="screen">cd .../myapp/WEB-INF/classes
</pre>
<p>Depending on the source language, you compile your script
sing the <code class="literal">--servlet</code> switch:
</p>
<pre class="screen">kawa --servlet -C hello.scm
</pre>
<p>or:
</p>
<pre class="screen">kawa --servlet --krl -C hello.krl
</pre>
<p>or:
</p>
<pre class="screen">kawa --servlet --xquery -C hello.xql
</pre>
<p>This lets the web-application find the compiled servlets.
Finally, you just need to add the new servlet to
the <code class="literal">WEB-INF/web.xml</code> file:
</p>
<pre class="screen">&lt;web-app&gt;
  &lt;display-name&gt;My Application&lt;/display-name&gt;

  &lt;servlet&gt;
    &lt;servlet-name&gt;MyHello&lt;/servlet-name&gt;
    &lt;servlet-class&gt;hello&lt;/servlet-class&gt;
  &lt;/servlet&gt;

  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;MyHello&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/hello&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
&lt;/web-app&gt;
</pre>
<p>The <code class="literal">&lt;servlet&gt;</code> clause says that the servlet named
<code class="literal">MyHello</code> is implemented by the Java class <code class="literal">hello</code>.
The <code class="literal">&lt;servlet-mapping&gt;</code> clause says that a request
URL <code class="literal">/hello</code> should be handled by the servlet named <code class="literal">MyHello</code>.
The URL is relative to the application context path,
so the actual URL would be <code class="literal">http://example.com/myapp/hello</code>.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Installing-a-servlet-under-Tomcat"></a>Installing a servlet under Tomcat</h4></div></div></div>
<a class="indexterm" name="idp49894288"></a><p>Apache's <a class="ulink" href="http://tomcat.apache.org/" target="_top">Tomcat</a> is an open-source
implementation of the servlet specifications.
After you <a class="ulink" href="http://tomcat.apache.org/download-60.cgi" target="_top">download it</a>,
uncompress it in some convenient location,
which is commonly referred to as <code class="literal">$CATALINA_HOME</code>.
</p>
<p>To install your web application, copy/move its directory
to be in the <code class="literal">$CATALINA_HOME/webapps</code> directory.
Thus for the example above you would have
a <code class="literal">$CATALINA_HOME/webapps/myapp</code> directory.
</p>
<p>To start or stop Tomcat use the scripts in <code class="literal">$CATALINA_HOME/bin</code>.
For example to start Tomcat on a GNU/Linux system run
<code class="literal">$CATALINA_HOME/bin/startup.sh</code>.  This will start a web server
that listens on the default port of 8080,
so you can browse the above example at <code class="literal">http://localhost:8080/myapp/hello</code>.
</p>
<p>If you're running Fedora GNU/Linux, you can use the <code class="literal">tomcat6</code> package:
</p>
<pre class="screen"># yum install tomcat6
# export CATALINA_HOME=/usr/share/tomcat6
</pre>
<p>You can the manage Tomcat like other system services.
You can install webapps under <code class="literal">$CATALINA_HOME/webapps</code>.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Installing-a-servlet-under-Glassfish"></a>Installing a servlet under Glassfish</h4></div></div></div>
<a class="indexterm" name="idp49906688"></a><p><a class="ulink" href="https://glassfish.dev.java.net/" target="_top">Glassfish</a> from Oracle/Sun
is a open-source “application server” that implements
Java EE 6, including the 3.0 servlet specification.
After you <a class="ulink" href="https://glassfish.dev.java.net/downloads/3.0.1-final.html" target="_top">download it</a>, uncompress it in some convenient location.
This location is called <em class="replaceable"><code>as-install-parent</code></em> in the
<a class="ulink" href="http://docs.sun.com/app/docs/doc/820-7689/aboaa?a=view" target="_top">Quick Start Guide</a>.
The commands you will use is most in <code class="literal"><em class="replaceable"><code>as-install</code></em>/bin</code>,
where <em class="replaceable"><code>as-install</code></em> is <code class="literal"><em class="replaceable"><code>as-install</code></em>/glassfish</code>.
</p>
<p>To start the server, do:
</p>
<pre class="screen"><em class="replaceable"><code>as-install</code></em>/bin/startserv
</pre>
<p>or under under Windows:
</p>
<pre class="screen"><em class="replaceable"><code>as-install</code></em>\bin\startserv.bat
</pre>
<p>The default post to listen to is <code class="literal">8080</code>;
you can the port (and lots of other properties)
using the adminstration console at port <code class="literal">4848</code>.
</p>
<p>A web application does not need to be any particular
location, instead you just install it with this command:
</p>
<pre class="screen"><em class="replaceable"><code>as-install</code></em>/bin/adadmin deploy <em class="replaceable"><code>appdir</code></em>
</pre>
<p>where <em class="replaceable"><code>appdir</code></em> is the application directory - <code class="literal">myapp</code> in the example.
(Use <code class="literal">asadmin.bat</code> under Windows.)
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Servlet-specific-script-functions"></a>Servlet-specific script functions</h4></div></div></div>
<p>The following functions only work within a servlet container.
To use these functions, first do:
</p>
<pre class="screen">(require 'servlets)
</pre>
<p>You can conditionalize your code to check for servlets, like this:
</p>
<pre class="screen">(cond-expand
 (in-servlet
   (require 'servlets)
   (format "[servlet-context: ~s]" (current-servlet-context)))
 (else
   "[Not in a servlet]"))
</pre>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49926160"></a><code class="function">current-servlet</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>When called from a Kawa servlet handler, returns the
actual <code class="literal">javax.servlet.http.HttpServlet</code> instance.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49930176"></a><code class="function">current-servlet-context</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Returns the context of the currently executing servlet,
as an instance of <code class="literal">javax.servlet.ServletContext</code>.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49934176"></a><code class="function">current-servlet-config</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Returns the <code class="literal">ServletConfig</code> of the currently executing servlet.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49938144"></a><code class="function">get-request</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Return the current servlet request, as an instance of
<code class="literal">javax.servlet.http.HttpServletRequest</code>.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49942112"></a><code class="function">get-response</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Return the current servlet response, as an instance of
<code class="literal">javax.servlet.http.HttpServletResponse</code>.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49946080"></a><code class="function">request-servlet-path</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Get the servlet path of the current request.
Similar to <code class="literal">request-script-path</code>, but not always the same,
depending on configuration, and does <span class="emphasis"><em>not</em></span> end with a <code class="literal">"/"</code>.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49951232"></a><code class="function">request-path-info</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Get the path info of the current request.
Corresponds to the CGI variable <code class="literal">PATH_INFO</code>.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49955216"></a><code class="function">servlet-context-realpath</code> [<em class="replaceable"><code>path</code></em>]</p>
<div class="blockquote"><blockquote class="blockquote"><p>Returns the file path of the current servlet's "Web application".
</p></blockquote></div>
</div>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="CGI-scripts"></a>Installing Kawa programs as CGI scripts</h3></div></div></div>
<p>The recommended way to have a web-server run a Kawa program
as a CGI script is to compile the Kawa program to a servlet
(as explained in <a class="xref" href="XML-tools.html#Server-side-scripts" title="Kawa: Web page scripts">the section called “Web page scripts”</a>, and then use
Kawa's supplied CGI-to-servlet bridge.
</p>
<p>First, compile your program to one or more class files
as explained in <a class="xref" href="XML-tools.html#Server-side-scripts" title="Kawa: Web page scripts">the section called “Web page scripts”</a>.  For example:
</p>
<pre class="screen">kawa --servlet --xquery -C hello.xql
</pre>
<p>Then copy the resulting <code class="literal">.class</code> files to your server's
CGI directory.  On Red Hat GNU/Linux, you can do the following (as root):
</p>
<pre class="screen">cp hello*.class /var/www/cgi-bin/
</pre>
<p>Next find the <code class="literal">cgi-servlet</code> program that Kawa builds and installs.
If you installed Kawa in the default place, it will be in
<code class="literal">/usr/local/bin/cgi-servlet</code>.
(You'll have this if you installed Kawa from source, but not
if you're just using Kawa <code class="literal">.jar</code> file.)
Copy this program into the same CGI directory:
</p>
<pre class="screen">cp /usr/local/bin/cgi-servlet /var/www/cgi-bin/
</pre>
<p>You can link instead of copying:
</p>
<pre class="screen">ln -s /usr/local/bin/cgi-servlet /var/www/cgi-bin/
</pre>
<p>However, because of security issues this may not work, so it is
safer to copy the file.  However, if you already have a copy
of <code class="literal">cgi-servlet</code> in the CGI-directory, it is safe to make
a hard link instead of making an extra copy.
</p>
<p>Make sure the files have the correct permissions:
</p>
<pre class="screen">chmod a+r /var/www/cgi-bin/hello*.class /var/www/cgi-bin/hello
chmod a+x /var/www/cgi-bin/hello
</pre>
<p>Now you should be able to run the Kawa program,
using the URL <a class="ulink" href="http://localhost/cgi-bin/hello" target="_top">http://localhost/cgi-bin/hello</a>.
It may take a few seconds to get the reply, mainly because of the
start-up time of the Java VM.  That is why servlets are
preferred.  Using the CGI interface can still be useful
for testing or when you can't run servlets.
</p>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="HTTP-requests"></a>Functions for accessing HTTP requests</h3></div></div></div>
<p>The following functions are useful for accessing
properties of a HTTP request, in a Kawa program that is
run either as a servlet or a CGI script.  These functions
can be used from plain Scheme, from KRL (whether
in BRL-compatible mode or not), and from XQuery.
</p>
<p>The examples below assume the request <code class="literal">http://example.com:8080/myapp/foo/bar?val1=xyz&amp;val2=abc</code>, where <code class="literal">myapp</code> is the application context.
We also assume that this is handled by a script <code class="literal">foo/+default+</code>.
</p>
<p>The file <code class="literal">testsuite/webtest/info/+default+</code> in the Kawa source distribution
calls most of these functions.
You can try it as described in <a class="xref" href="XML-tools.html#Self-configuring-page-scripts" title="Kawa: Self-configuring web page scripts">the section called “Self-configuring web page scripts”</a>.
</p>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Request-URL-components"></a>Request URL components</h4></div></div></div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49981328"></a><code class="function">request-URI</code></p>
<div class="blockquote"><blockquote class="blockquote">
<p>Returns the URI of the request, as a value of type <code class="literal">URI</code>.
This excludes the server specification,
but includes the query string.
(It is the combination of CGI variables <code class="literal">SCRIPT_NAME</code>,
<code class="literal">PATH_INFO</code>, and <code class="literal">QUERY_STRING</code>.
Using servlets terminology, it is the combination of
Context Path, Servlet Path, PathInfo, and Query String.)
</p>
<pre class="screen">(request-URI) ⇒ "/myapp/foo/bar?val1=xyz&amp;val2=abc"
</pre>
</blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49988272"></a><code class="function">request-path</code></p>
<div class="blockquote"><blockquote class="blockquote">
<p>Returns the URI of the request, as a value of type <code class="literal">URI</code>.
This excludes the server specification and the query string.
Equivalent to <code class="literal">(path-file (request-URI))</code>.
(It is the combination of CGI variables <code class="literal">SCRIPT_NAME</code>, and
<code class="literal">PATH_INFO</code>.
Same as the concatenation of <code class="literal">(request-context-path)</code>,
<code class="literal">(request-script-path)</code>, and <code class="literal">(request-local-path)</code>.
Using servlets terminology, it is the combination of
Context Path, Servlet Path, and PathInfo.)
</p>
<pre class="screen">(request-path) ⇒ "/myapp/foo/bar"
</pre>
</blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp49997264"></a><code class="function">request-uri</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>This function is deprecated, because of possible confusion
with <code class="literal">request-URI</code>.  Use <code class="literal">request-path</code> instead.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50001984"></a><code class="function">request-url</code></p>
<div class="blockquote"><blockquote class="blockquote">
<p>Returns the complete URL of the request, except the query string.
The result is a <code class="literal">java.lang.StringBuffer</code>.
</p>
<pre class="screen">(request-url) ⇒ "http://example.com:8080/myapp/foo/bar"
</pre>
</blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50006672"></a><code class="function">request-context-path</code></p>
<div class="blockquote"><blockquote class="blockquote">
<p>Returns the context path, relative to the server root.
This is an initial substring of the <code class="literal">(request-path)</code>.
Similar to the Context Path of a servlet request,
except that it ends with a <code class="literal">"/"</code>.
</p>
<pre class="screen">(request-context-path) ⇒ "/myapp/"
</pre>
</blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50012064"></a><code class="function">request-script-path</code></p>
<div class="blockquote"><blockquote class="blockquote">
<p>Returns the path of the script, relative to the context.
This is either an empty string, or a string that ends with <code class="literal">"/"</code>,
but does not start with one. (The reason for this is to produce URIs
that work better with operations like <code class="literal">resolve-uri</code>.)
This is conceptually similar to <code class="literal">request-servlet-path</code>,
though not always the same, and the <code class="literal">"/"</code> conventions differ.
</p>
<pre class="screen">(request-script-path) ⇒ "foo/"
</pre>
</blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50018992"></a><code class="function">request-local-path</code></p>
<div class="blockquote"><blockquote class="blockquote">
<p>Returns the remainder of the <code class="literal">request-path</code>,
relative to the <code class="literal">request-script-path</code>.
</p>
<pre class="screen">(request-local-path) ⇒ "bar"
</pre>
</blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50024240"></a><code class="function">request-query-string</code></p>
<div class="blockquote"><blockquote class="blockquote">
<p>Returns the query string from an HTTP request.  The query string is
the part of the request URL after a question mark.
Returns false if there was no query string.
Corresponds to the CGI variable <code class="literal">QUERY_STRING</code>.
</p>
<pre class="screen">(request-query-string) ⇒ "val1=xyz&amp;val2=abc"
</pre>
</blockquote></div>
</div>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Request-parameters"></a>Request parameters</h4></div></div></div>
<p>Request parameters are used for data returned from forms,
and for other uses.
They may be encoded in the query string or in the request body.
</p>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50030560"></a><code class="function">request-parameter</code><em class="replaceable"><code> name</code></em> [<em class="replaceable"><code>default</code></em>]</p>
<div class="blockquote"><blockquote class="blockquote">
<p>If there is a parameter with the given name (a string),
return the (first) corresponding value, as a string.
Otherwise, return the <em class="replaceable"><code>default</code></em> value,
or <code class="literal">#!null</code> if there is no <em class="replaceable"><code>default</code></em>.
</p>
<pre class="screen">(request-parameter "val1") ⇒ "xyz"
(request-parameter "val9" "(missing)") ⇒ "(missing)"
</pre>
</blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50037248"></a><code class="function">request-parameters</code><em class="replaceable"><code> name</code></em></p>
<div class="blockquote"><blockquote class="blockquote">
<p>If there is are one or more parameter with the given name (a string),
return them all (as multiple values).
Otherwise, return no values (i.e. <code class="literal">(values)</code>).
</p>
<pre class="screen">(request-parameters "val1") ⇒ "xyz"
(request-parameters "val9") ⇒ #!void
</pre>
</blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50042272"></a><code class="function">request-parameter-map</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Request a map of all the parameters.
This is a map from strings to a sequence of strings.
(Specifically, a <code class="literal">java.util.Map&lt;String,java.util.List&lt;String&gt;&gt;</code>.)
</p></blockquote></div>
</div>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Request-headers"></a>Request headers</h4></div></div></div>
<p>The request headers are a set of (keyword, string)-pairs
transmitted as part of the HTTP request, before the request body.
</p>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50047968"></a><code class="function">request-header</code><em class="replaceable"><code> name</code></em></p>
<div class="blockquote"><blockquote class="blockquote">
<p>If there is a header with the given <em class="replaceable"><code>name</code></em> (a string),
return the corresponding value string.
Otherwise, return <code class="literal">#!null</code>.
</p>
<pre class="screen">(request-header "accept-language") ⇒ "en-us,en;q=0.5"
</pre>
</blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50053264"></a><code class="function">request-header-map</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Request a map of all the headers.
This is a map from strings to a sequence of strings.
(Specifically, a <code class="literal">java.util.Map&lt;String,java.util.List&lt;String&gt;&gt;</code>.)
</p></blockquote></div>
</div>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Request-body"></a>Request body</h4></div></div></div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50058432"></a><code class="function">request-input-port</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Return a textual input port for reading the request body,
as a sequence of characters.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50061728"></a><code class="function">request-input-stream</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Return a binary input stream for reading the request body,
as a sequence of bytes.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50065024"></a><code class="function">request-body-string</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Return the entire request body as a string
</p></blockquote></div>
</div>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Request-IP-addresses-and-ports"></a>Request IP addresses and ports</h4></div></div></div>
<p>Information about the interface and port on which the request was received.
</p>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50069744"></a><code class="function">request-local-socket-address</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>The local address on which the request was received.
This is the combination of <code class="literal">(request-local-host)</code>
and <code class="literal">(request-local-port)</code>, as an instance of
<code class="literal">java.net.InetSocketAddress</code>.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50075088"></a><code class="function">request-local-host</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Get the IP address of the interface on which request was received,
as an <code class="literal">java.net.InetAddress</code>.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50078944"></a><code class="function">request-local-IP-address</code></p>
<div class="blockquote"><blockquote class="blockquote">
<p>Get the IP address of the interface on which request was received,
a string in numeric form:
</p>
<pre class="screen">(request-local-host) ⇒ "127.0.0.1"
</pre>
</blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50082752"></a><code class="function">request-local-port</code></p>
<div class="blockquote"><blockquote class="blockquote">
<p>Get the port this request was received on.
</p>
<pre class="screen">(request-local-port) ⇒ 8080
</pre>
</blockquote></div>
</div>
<p>Information about the interface and port of the remote client that invoked the request.
</p>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50087024"></a><code class="function">request-remote-socket-address</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>The address of the remote client (usually a web browser)
which invoked the request.
This is the combination of <code class="literal">(request-remove-host)</code>
and <code class="literal">(request-remote-port)</code>, as an instance of
<code class="literal">java.net.InetSocketAddress</code>.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50092336"></a><code class="function">request-remote-host</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Get the IP address of the remote client which invoked the request,
as an <code class="literal">java.net.InetAddress</code>.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50096192"></a><code class="function">request-remote-IP-address</code></p>
<div class="blockquote"><blockquote class="blockquote">
<p>Get the IP address of the remote client which invoked the request,
as a string in numeric form.
</p>
<pre class="screen">(request-remote-host) ⇒ "123.45.6.7"
</pre>
</blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50100000"></a><code class="function">request-remote-port</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>The port used by the remote client.
</p></blockquote></div>
</div>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Miscellaneous-request-properties"></a>Miscellaneous request properties</h4></div></div></div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50104336"></a><code class="function">request-path-translated</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Map the request-path to a file name (a string)
in the server application directory.
Corresponds to the CGI variable <code class="literal">PATH_TRANSLATED</code>.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50108352"></a><code class="function">request-method</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Returns the method of the HTTP request, usually <code class="literal">"GET"</code>
or <code class="literal">"POST"</code>.  Corresponds to the CGI variable <code class="literal">REQUEST_METHOD</code>.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50113760"></a><code class="function">request-scheme</code></p>
<div class="blockquote"><blockquote class="blockquote"><p>Returns the scheme (protocol) of the request.
Usually <code class="literal">"http"</code>, or <code class="literal">"https"</code>.
</p></blockquote></div>
</div>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="HTTP-response"></a>Generating HTTP responses</h3></div></div></div>
<p>The result of evaluating the top-level expressions of a web page script
becomes the HTTP response that the servlet sends back to the browser.
The result is typically an HTML/XML element code object
Kawa will automatically format the result as appropriate for the type.
Before the main part of the response there may be
special "response header values",
as created by the <code class="literal">response-header</code> function.
Kawa will use the response header values to set various
required and optional fields of the HTTP response.
Note that <code class="literal">response-header</code> does not actually do anything
until it is "printed" to the standard output.
Note also that a <code class="literal">"Content-Type"</code> response value is
special since it controls the formatting of the following
non-response-header values.
</p>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50123760"></a><code class="function">response-header</code><em class="replaceable"><code> key</code></em><em class="replaceable"><code> value</code></em></p>
<div class="blockquote"><blockquote class="blockquote"><p>Create the response header ‘<code class="literal"><em class="replaceable"><code>key</code></em>: <em class="replaceable"><code>value</code></em></code>’ in the HTTP
response.  The result is a "response header value" (of some unspecified
type).  It does not directly set or print a response header, but only
does so when you actually "print" its value to the response output stream.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50129216"></a><code class="function">response-content-type</code><em class="replaceable"><code> type</code></em></p>
<div class="blockquote"><blockquote class="blockquote"><p>Species the content-type of the result - for example <code class="literal">"text/plain"</code>.
Convenience function for <code class="literal">(response-header "Content-Type" <em class="replaceable"><code>type</code></em>)</code>.
</p></blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50134624"></a><code class="function">error-response</code><em class="replaceable"><code> code</code></em> [<em class="replaceable"><code>message</code></em>]</p>
<div class="blockquote"><blockquote class="blockquote">
<p>Creates a response-header with an error code of <em class="replaceable"><code>code</code></em> and a
response message of <em class="replaceable"><code>message</code></em>.
(For now this is the same as <code class="literal">response-status</code>.)
</p>
<p>Note this also returns a response-header value, which does not actually
do anything unless it is returned as the result of executing a servlet body.
</p>
</blockquote></div>
</div>
<div class="informalfigure">
<p class="synopsis"><a class="indexterm" name="idp50140880"></a><code class="function">response-status</code><em class="replaceable"><code> code</code></em> [<em class="replaceable"><code>message</code></em>]</p>
<div class="blockquote"><blockquote class="blockquote"><p>Creates a response-header with an status code of <em class="replaceable"><code>code</code></em> and a
response message of <em class="replaceable"><code>message</code></em>.
(For now this is the same as <code class="literal">error-response</code>.)
</p></blockquote></div>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="XML-beyond-Scheme"></a>Using non-Scheme languages for XML/HTML</h3></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="XQuery-language"></a>XQuery language</h4></div></div></div>
<p>Bundled with Kawa is a fairly complete implementation of W3C's
new <a class="ulink" href="http://www.w3c.org/XML/Query" target="_top">XML Query language</a>.
If you start Kawa with the <code class="literal">--xquery</code> it selects the "XQuery"
source language; this also prints output using XML syntax.
See the <a class="ulink" href="http://www.gnu.org/software/qexo/" target="_top">Qexo (Kawa-XQuery) home page</a>
for examples and more information.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="XSL-transformations"></a>XSL transformations</h4></div></div></div>
<p>There is an experimental implementation of the XSLT (XML Stylesheet
Language Transformations) language.  Selecting <code class="literal">--xslt</code> at the
Kawa command line will parse a source file according to the syntax
on an XSLT stylesheet.
See the <a class="ulink" href="http://www.gnu.org/software/qexo/xslt.html" target="_top">Kawa-XSLT page</a>
for more information.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="KRL"></a>KRL - The Kawa Report Language for generating XML/HTML</h4></div></div></div>
<p>KRL (the "Kawa Report Language") is powerful Kawa dialect for embedding
Scheme code in text files such as HTML or XML templates.  You select
the KRL language by specifying <code class="literal">--krl</code> on the Kawa command line.
</p>
<p>KRL is based on on <a class="ulink" href="http://brl.sourceforge.net/" target="_top">BRL</a>,
Bruce Lewis's "Beautiful Report Language", and
uses some of BRL's code, but there are some experimental differences,
and the implementation core is different.  You can run KRL in
BRL-compatility-mode by specifying <code class="literal">--brl</code> instead of <code class="literal">--krl</code>.
</p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Differences-between-KRL-and-BRL"></a>Differences between KRL and BRL</h4></div></div></div>
<p>This section summarizes the known differences between KRL and BRL.
Unless otherwise specified, KRL in BRL-compatibility mode will
act as BRL.
</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem"><p>In BRL a normal Scheme string <code class="literal">"mystring"</code> is the same
as the inverted quote string <code class="literal">]mystring[</code>, and both are instances
of the type <code class="literal">&lt;string&gt;</code>.
In KRL <code class="literal">"mystring"</code> is a normal Scheme string of type <code class="literal">&lt;string&gt;</code>,
but <code class="literal">]mystring[</code> is special type that suppresses output escaping.
(It is equivalent to <code class="literal">(unescaped-data "mystring")</code>.)
</p></li>
<li class="listitem"><p>When BRL writes out a string, it does not do any processing
to escape special characters like <code class="literal">&lt;</code>.  However, KRL in its default
mode does normally escape characters and strings.  Thus <code class="literal">"&lt;a&gt;"</code>
is written as <code class="literal">&amp;lt;a&amp;gr;</code>.
You can stop it from doing this by overriding the output format, for example
by specifying <code class="literal">--output-format scheme</code> on the Kawa command line,
or by using the <code class="literal">unescaped-data</code> function.
</p></li>
<li class="listitem"><p>Various Scheme syntax forms, including <code class="literal">lambda</code>,
take a <a class="link" href="Syntax.html#meta-body"><em class="replaceable"><code>body</code></em></a>, which is a list of one or more declarations and
expressions.  In normal Scheme and in BRL the value of a <em class="replaceable"><code>body</code></em>
is the value of the last expression.  In KRL the value of a <em class="replaceable"><code>body</code></em>
is the concatenation of all the values of the expressions,
as if using <code class="literal">values-append</code>.
</p></li>
<li class="listitem"><p>In BRL a word starting with a colon is a keyword.
In KRL a word starting with a colon is an identifier, which by
default is bound to the <code class="literal">make-element</code> function specialized
to take the rest of the word as the tag name (first argument).
</p></li>
<li class="listitem"><p>BRL has an extensive utility library.  Most of this has not yet been ported
to KRL, even in BRL-compatibility mode.
</p></li>
</ul></div>
</div>
</div>
</div>
<div class="navfooter">
<ul>
<li><b class="toc"><a href="XML-tools.html#Formatting-XML">Formatting XML</a></b></li>
<li><b class="toc"><a href="XML-tools.html#Creating-HTML-nodes">Creating HTML nodes</a></b></li>
<li><b class="toc"><a href="XML-tools.html#Creating-XML-nodes">Creating XML nodes</a></b></li>
<li><b class="toc"><a href="XML-tools.html#XML-literals">XML literals</a></b></li>
<li><b class="toc"><a href="XML-tools.html#Server-side-scripts">Web page scripts</a></b></li>
<li><b class="toc"><a href="XML-tools.html#Self-configuring-page-scripts">Self-configuring web page scripts</a></b></li>
<li><b class="toc"><a href="XML-tools.html#Servlets">Installing web page scripts as Servlets</a></b></li>
<li><b class="toc"><a href="XML-tools.html#CGI-scripts">Installing Kawa programs as CGI scripts</a></b></li>
<li><b class="toc"><a href="XML-tools.html#HTTP-requests">Functions for accessing HTTP requests</a></b></li>
<li><b class="toc"><a href="XML-tools.html#HTTP-response">Generating HTTP responses</a></b></li>
<li><b class="toc"><a href="XML-tools.html#XML-beyond-Scheme">Using non-Scheme languages for XML/HTML</a></b></li>
</ul>
<p>
          Up: <a accesskey="u" href="Documentation.html">Documentation</a></p>
<p>
        Previous: <a accesskey="p" href="Objects-Classes-and-Modules.html">Object, Classes and Modules</a></p>
<p>
        Next: <a accesskey="n" href="Miscellaneous.html">Miscellaneous topics</a></p>
</div>
</div>
 </body>
</html>
